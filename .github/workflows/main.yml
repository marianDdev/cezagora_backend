name: deploy_on_main

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deployment:
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        uses: actions/checkout@v3


      - name: Make envfile
        uses: SpicyPizza/create-envfile@v1.3
        with:
          file_name: .env.production
          fail_on_empty: false
          APP_NAME: Cezagora
          APP_ENV: production
          APP_DEBUG: true
          APP_URL: https://api.cezagora.com
          SANCTUM_STATEFUL_DOMAINS: https://cezagora.com

          LOG_CHANNEL: stack
          LOG_DEPRECATIONS_CHANNEL: null
          LOG_LEVEL: debug

          DB_CONNECTION: mysql
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: 3306
          DB_DATABASE: ${{ secrets.database }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASS }}

          CACHE_DRIVER: file
          FILESYSTEM_DISK: s3
          QUEUE_CONNECTION: sync
          SESSION_DRIVER: file
          SESSION_LIFETIME: 120

          MEMCACHED_HOST: https://api.cezagora.com

          REDIS_HOST: https://api.cezagora.com
          REDIS_PASSWORD: null
          REDIS_PORT: 6379

          MAIL_MAILER: smtp
          MAIL_HOST: smtp.mailtrap.io
          MAIL_PORT: 2525
          MAIL_USERNAME: ${{ secrets.MAILTRAP_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAILTRAP_PASS }}
          MAIL_ENCRYPTION: tls
          MAIL_FROM_ADDRESS: cezagora@cezius.tech
          MAIL_FROM_NAME: CezAgora

          PUSHER_APP_ID: ${{ secrets.PUSHER_ID }}
          PUSHER_APP_KEY: ${{ secrets.PUSHER_KEY }}
          PUSHER_APP_SECRET: ${{ secrets.PUSHER_SECRET }}
          PUSHER_PORT: 443
          PUSHER_SCHEME: https
          PUSHER_APP_CLUSTER: eu

          VITE_PUSHER_APP_KEY: "${PUSHER_APP_KEY}"
          VITE_PUSHER_HOST: "${PUSHER_HOST}"
          VITE_PUSHER_PORT: "${PUSHER_PORT}"
          VITE_PUSHER_SCHEME: "${PUSHER_SCHEME}"
          VITE_PUSHER_APP_CLUSTER: "${PUSHER_APP_CLUSTER}"

          MEDIA_PREFIX: "uploads"

          BROADCAST_DRIVER: ably
          ABLY_KEY=OZwOXg: ${{ secrets.ABLY_KEY }}

      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
      - name: Generate key
        run: php artisan key:generate
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      - name: Run migrations
        run: php artisan migrate

      - name: Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.3.2
        with:
          server: ns1.dreamhost.com
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: /home/cezagora/api.cezagora.com
